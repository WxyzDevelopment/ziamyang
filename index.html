<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ziamyang - POS System</title>
    <link rel="icon" href="assets/logo.png">
    <!-- Google Fonts and Font Awesome -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary: #FF6400;
            --primary-dark: #E55A00;
            --primary-light: #FF8533;
            --text: #323232;
            --text-light: #666666;
            --text-lighter: #999999;
            --background: #FFFFFF;
            --background-alt: #F5F5F5;
            --background-dark: #2C2C2C;
            --border: #E0E0E0;
            --success: #4CAF50;
            --error: #F44336;
            --warning: #FF9800;
            --info: #2196F3;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
            --radius: 8px;
            --radius-lg: 12px;
            --sidebar-width: 260px;
            --header-height: 70px;
            --transition: all 0.3s ease;
        }

        .dark-mode {
            --primary: #FF8533;
            --primary-dark: #FF6400;
            --primary-light: #FFA366;
            --text: #F5F5F5;
            --text-light: #CCCCCC;
            --text-lighter: #AAAAAA;
            --background: #1E1E1E;
            --background-alt: #2C2C2C;
            --background-dark: #121212;
            --border: #444444;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.35);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            color: var(--text);
            background-color: var(--background);
            line-height: 1.6;
            transition: var(--transition);
            min-height: 100vh;
        }

        a {
            text-decoration: none;
            color: inherit;
        }

        ul {
            list-style: none;
        }

        button {
            cursor: pointer;
            font-family: 'Roboto', sans-serif;
            border: none;
            outline: none;
        }

        input, select, textarea {
            font-family: 'Roboto', sans-serif;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 12px 16px;
            font-size: 16px;
            background-color: var(--background);
            color: var(--text);
            transition: var(--transition);
            width: 100%;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(255, 100, 0, 0.2);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
        }

        .toast {
            padding: 16px 20px;
            border-radius: var(--radius);
            background-color: var(--background);
            color: var(--text);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(100%);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            border-left: 4px solid var(--primary);
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.success {
            border-left-color: var(--success);
        }

        .toast.error {
            border-left-color: var(--error);
        }

        .toast.warning {
            border-left-color: var(--warning);
        }

        .toast.info {
            border-left-color: var(--info);
        }

        .toast i {
            font-size: 20px;
        }

        .toast .toast-content {
            flex: 1;
        }

        .toast .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .toast .toast-message {
            font-size: 14px;
            color: var(--text-light);
        }

        .toast .toast-close {
            background: none;
            border: none;
            color: var(--text-lighter);
            font-size: 18px;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Auth Pages */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--background-alt) 0%, var(--background) 100%);
        }

        .auth-box {
            width: 100%;
            max-width: 420px;
            background-color: var(--background);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        .auth-header {
            padding: 30px 30px 20px;
            text-align: center;
            background-color: var(--primary);
            color: white;
        }

        .auth-logo img {
            width: 30vw;
            max-width: 180px;
            min-width: 120px;
            height: auto;
            object-fit: contain;
            display: block;
            margin: 0 auto;
        }

        .auth-header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .auth-header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .auth-form {
            padding: 30px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 25px;
            border-radius: var(--radius);
            overflow: hidden;
            background-color: var(--background-alt);
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            font-weight: 500;
            background: none;
            color: var(--text-light);
            transition: var(--transition);
        }

        .auth-tab.active {
            background-color: var(--primary);
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text);
        }

        .auth-submit {
            width: 100%;
            padding: 14px;
            background-color: var(--primary);
            color: white;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 16px;
            transition: var(--transition);
            margin-top: 10px;
        }

        .auth-submit:hover {
            background-color: var(--primary-dark);
        }

        .auth-divider {
            display: flex;
            align-items: center;
            margin: 25px 0;
            color: var(--text-lighter);
        }

        .auth-divider::before,
        .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background-color: var(--border);
        }

        .auth-divider span {
            padding: 0 15px;
            font-size: 14px;
        }

        .auth-social {
            width: 100%;
            padding: 14px;
            background-color: var(--background-alt);
            color: var(--text);
            border-radius: var(--radius);
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: var(--transition);
        }

        .auth-social:hover {
            background-color: var(--border);
        }

        .auth-footer {
            text-align: center;
            padding: 20px;
            font-size: 14px;
            color: var(--text-light);
            border-top: 1px solid var(--border);
        }

        .auth-footer a {
            color: var(--primary);
            font-weight: 500;
        }

        /* Main App */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--background);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
            transition: var(--transition);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-logo img {
            width: 32px;
            height: 32px;
            object-fit: contain;
            display: block;
        }

        .sidebar-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
        }

        .sidebar-nav {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }

        .sidebar-nav ul {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .sidebar-nav li a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 20px;
            color: var(--text-light);
            transition: var(--transition);
            font-weight: 500;
        }

        .sidebar-nav li a:hover,
        .sidebar-nav li a.active {
            background-color: var(--background-alt);
            color: var(--primary);
        }

        .sidebar-nav li a i {
            width: 20px;
            text-align: center;
            font-size: 18px;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid var(--border);
            font-size: 12px;
            color: var(--text-lighter);
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            transition: var(--transition);
        }

        /* Header */
        .header {
            height: var(--header-height);
            background-color: var(--background);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            position: sticky;
            top: 0;
            z-index: 99;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .sidebar-toggle {
            display: none;
            background: none;
            color: var(--text);
            font-size: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .sidebar-toggle:hover {
            background-color: var(--background-alt);
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .theme-toggle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--background-alt);
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: var(--transition);
        }

        .theme-toggle:hover {
            background-color: var(--border);
        }

        .fullscreen-toggle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--background-alt);
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: var(--transition);
        }

        .fullscreen-toggle:hover {
            background-color: var(--border);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: var(--radius);
            transition: var(--transition);
            position: relative;
        }

        .user-profile:hover {
            background-color: var(--background-alt);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 500;
            font-size: 14px;
        }

        .user-role {
            font-size: 12px;
            color: var(--text-light);
        }

        .user-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--background);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            overflow: hidden;
            display: none;
            z-index: 101;
            border: 1px solid var(--border);
        }

        .user-profile:hover .user-menu {
            display: block;
        }

        .user-menu a {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            color: var(--text);
            transition: var(--transition);
        }

        .user-menu a:hover {
            background-color: var(--background-alt);
            color: var(--primary);
        }

        .user-menu a i {
            width: 20px;
            text-align: center;
        }

        /* Page Content */
        .page-content {
            padding: 30px;
        }

        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: var(--background);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 24px;
            transition: var(--transition);
            border: 1px solid var(--border);
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-light);
        }

        .card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .card-icon.sales {
            background-color: var(--primary);
        }

        .card-icon.income {
            background-color: var(--success);
        }

        .card-icon.profit {
            background-color: var(--info);
        }

        .card-icon.products {
            background-color: var(--warning);
        }

        .card-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .card-change {
            font-size: 14px;
            color: var(--text-light);
        }

        .card-change.positive {
            color: var(--success);
        }

        .card-change.negative {
            color: var(--error);
        }

        /* Section Header */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .section-title {
            font-size: 22px;
            font-weight: 600;
        }

        .btn {
            padding: 10px 20px;
            border-radius: var(--radius);
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
            font-size: 15px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--background-alt);
            color: var(--text);
        }

        .btn-secondary:hover {
            background-color: var(--border);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #3d8b40;
        }

        .btn-danger {
            background-color: var(--error);
            color: white;
        }

        .btn-danger:hover {
            background-color: #d32f2f;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
        }

        /* Tables */
        .table-container {
            background-color: var(--background);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            border: 1px solid var(--border);
            margin-bottom: 30px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background-color: var(--background-alt);
        }

        th {
            padding: 16px 20px;
            text-align: left;
            font-weight: 600;
            color: var(--text);
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        tbody tr:hover {
            background-color: var(--background-alt);
        }

        .text-right {
            text-align: right;
        }

        .text-center {
            text-align: center;
        }

        .actions {
            display: flex;
            gap: 8px;
        }

        /* POS Styles */
        .pos-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            height: calc(100vh - var(--header-height) - 60px);
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .product-card {
            background-color: var(--background);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: var(--transition);
            border: 1px solid var(--border);
            cursor: pointer;
        }

        .product-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .product-image {
            height: 140px;
            background-color: var(--background-alt);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-lighter);
            font-size: 40px;
            overflow: hidden;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-info {
            padding: 16px;
        }

        .product-name {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .product-price {
            color: var(--primary);
            font-weight: 700;
            font-size: 18px;
        }

        .product-stock {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 4px;
        }

        .cart-container {
            background-color: var(--background);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .cart-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .cart-header h3 {
            font-size: 20px;
            font-weight: 600;
        }

        .cart-items {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .cart-item-price {
            font-size: 14px;
            color: var(--text-light);
        }

        .cart-item-quantity {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quantity-btn {
            width: 28px;
            height: 28px;
            border-radius: 4px;
            background-color: var(--background-alt);
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: var(--transition);
        }

        .quantity-btn:hover {
            background-color: var(--border);
        }

        .cart-item-quantity span {
            min-width: 30px;
            text-align: center;
            font-weight: 500;
        }

        .cart-item-total {
            font-weight: 600;
            min-width: 80px;
            text-align: right;
        }

        .cart-footer {
            padding: 20px;
            border-top: 1px solid var(--border);
        }

        .cart-summary {
            margin-bottom: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .summary-row.total {
            font-size: 20px;
            font-weight: 700;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .cart-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--background);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            padding: 24px 30px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            color: var(--text-light);
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }

        .modal-close:hover {
            background-color: var(--background-alt);
            color: var(--text);
        }

        .modal-body {
            padding: 30px;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Form Groups */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* Settings */
        .settings-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 30px;
        }

        .settings-nav {
            background-color: var(--background);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .settings-nav ul {
            display: flex;
            flex-direction: column;
        }

        .settings-nav li a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 18px 20px;
            border-bottom: 1px solid var(--border);
            color: var(--text);
            transition: var(--transition);
        }

        .settings-nav li:last-child a {
            border-bottom: none;
        }

        .settings-nav li a:hover,
        .settings-nav li a.active {
            background-color: var(--background-alt);
            color: var(--primary);
        }

        .settings-content {
            background-color: var(--background);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            padding: 30px;
        }

        .avatar-upload {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .avatar-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: var(--background-alt);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 3px solid var(--border);
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-upload-actions {
            flex: 1;
        }

        /* Filter Controls */
        .filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-label {
            font-weight: 500;
            color: var(--text-light);
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            font-size: 14px;
            color: var(--text-light);
            border-top: 1px solid var(--border);
            margin-top: 30px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
            }
            .sidebar-toggle {
                display: flex;
            }
            .pos-container {
                grid-template-columns: 1fr;
                height: auto;
            }
            .products-grid {
                max-height: 500px;
            }
            .settings-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            .form-row {
                grid-template-columns: 1fr;
            }
            .header {
                padding: 0 20px;
            }
            .page-content {
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .auth-box {
                border-radius: 0;
            }
            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .table-container {
                border-radius: 0;
                border-left: none;
                border-right: none;
            }
        }
    </style>
</head>
<body>
    <!-- Toast Notifications Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Auth Page -->
    <div id="authPage" class="auth-container">
        <div class="auth-box">
            <div class="auth-header">
                <div class="auth-logo">
                    <img src="assets/logo.png" alt="Logo">
                </div>
                <p>SAMYANG BUSINESS NI RHYRHY</p>
            </div>
            
            <div class="auth-form">
                <div class="auth-tabs">
                    <button class="auth-tab active" id="loginTab">Login</button>
                    <button class="auth-tab" id="signupTab">Sign Up</button>
                </div>
                
                <!-- Login Form -->
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label" for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="auth-submit">Login</button>
                </form>
                
                <!-- Signup Form -->
                <form id="signupForm" style="display: none;">
                    <div class="form-group">
                        <label class="form-label" for="signupName">Full Name</label>
                        <input type="text" id="signupName" placeholder="Enter your full name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="signupEmail">Email</label>
                        <input type="email" id="signupEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" placeholder="Create a password" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" placeholder="Confirm your password" required>
                    </div>
                    <button type="submit" class="auth-submit">Create Account</button>
                </form>
                
                <div class="auth-divider">
                    <span>Or continue with</span>
                </div>
                
                <button class="auth-social" id="googleSignIn">
                    <i class="fab fa-google"></i>
                    Sign in with Google
                </button>
            </div>
            
            <div class="auth-footer">
                <p>By continuing, you agree to our Terms & Conditions</p>
                <p>Powered by: <strong>Wxyz Development | Steven Macapañas</strong></p>
            </div>
        </div>
    </div>

    <!-- Main App (Initially Hidden) -->
    <div id="appContainer" class="app-container" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <img src="assets/logo.png" alt="Logo">
                </div>
                <div class="sidebar-title">Ziamyang</div>
            </div>
            
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="#" data-page="dashboard" class="active"><i class="fas fa-home"></i> Dashboard</a></li>
                    <li><a href="#" data-page="pos"><i class="fas fa-cash-register"></i> POS System</a></li>
                    <li><a href="#" data-page="products"><i class="fas fa-box-open"></i> Products</a></li>
                    <li><a href="#" data-page="sales"><i class="fas fa-chart-line"></i> Sales History</a></li>
                    <li><a href="#" data-page="reports"><i class="fas fa-chart-bar"></i> Income Reports</a></li>
                    <li><a href="#" data-page="settings"><i class="fas fa-cog"></i> Settings</a></li>
                </ul>
            </nav>
            
            <div class="sidebar-footer">
                <p>Powered by: Wxyz Development | Steven Macapañas</p>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <button class="sidebar-toggle" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title" id="pageTitle">Dashboard</h1>
                </div>
                
                <div class="header-right">
                    <button class="theme-toggle" id="themeToggle">
                        <i class="fas fa-moon"></i>
                    </button>
                    
                    <button class="fullscreen-toggle" id="fullscreenToggle" title="Fullscreen">
                        <i class="fas fa-expand"></i>
                    </button>
                    
                    <div class="user-profile" id="userProfile">
                        <div class="user-avatar" id="userAvatar">
                            <span id="avatarInitials">U</span>
                            <img id="avatarImage" style="display: none;" alt="Profile">
                        </div>
                        <div class="user-info">
                            <div class="user-name" id="userName">User</div>
                            <div class="user-role">Admin</div>
                        </div>
                        <div class="user-menu">
                            <a href="#" data-page="settings"><i class="fas fa-user-cog"></i> Profile Settings</a>
                            <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- Page Content -->
            <div class="page-content" id="pageContent">
                <!-- Dashboard Content -->
                <div id="dashboardPage" class="page">
                    <div class="dashboard-cards">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Today's Sales</h3>
                                <div class="card-icon sales">
                                    <i class="fas fa-shopping-cart"></i>
                                </div>
                            </div>
                            <div class="card-value" id="todaySales">₱0.00</div>
                            <div class="card-change positive" id="todaySalesChange">+0% from yesterday</div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Total Income</h3>
                                <div class="card-icon income">
                                    <i class="fas fa-money-bill-wave"></i>
                                </div>
                            </div>
                            <div class="card-value" id="totalIncome">₱0.00</div>
                            <div class="card-change positive" id="incomeChange">+0% from last month</div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Net Profit</h3>
                                <div class="card-icon profit">
                                    <i class="fas fa-chart-pie"></i>
                                </div>
                            </div>
                            <div class="card-value" id="netProfit">₱0.00</div>
                            <div class="card-change positive" id="profitChange">+0% from last month</div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Products</h3>
                                <div class="card-icon products">
                                    <i class="fas fa-boxes"></i>
                                </div>
                            </div>
                            <div class="card-value" id="totalProducts">0</div>
                            <div class="card-change positive" id="productsChange">0 in stock</div>
                        </div>
                    </div>
                    
                    <div class="section-header">
                        <h2 class="section-title">Recent Sales</h2>
                        <button class="btn btn-primary" id="viewAllSales">
                            <i class="fas fa-list"></i> View All Sales
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Transaction ID</th>
                                    <th>Items</th>
                                    <th>Total Amount</th>
                                    <th>Net Profit</th>
                                </tr>
                            </thead>
                            <tbody id="recentSalesTable">
                                <tr>
                                    <td colspan="5" class="text-center">No recent sales</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- POS Page -->
                <div id="posPage" class="page" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title">Point of Sale</h2>
                        <div class="filter-controls">
                            <div class="filter-group">
                                <label class="filter-label">Filter by Category:</label>
                                <select id="categoryFilter">
                                    <option value="all">All Categories</option>
                                    <option value="noodles">Noodles</option>
                                    <option value="sauce">Sauce</option>
                                    <option value="snacks">Snacks</option>
                                    <option value="beverages">Beverages</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="pos-container">
                        <div class="products-section">
                            <div class="products-grid" id="productsGrid">
                                <!-- Products will be loaded here -->
                            </div>
                        </div>
                        
                        <div class="cart-section">
                            <div class="cart-container">
                                <div class="cart-header">
                                    <h3>Current Order</h3>
                                </div>
                                
                                <div class="cart-items" id="cartItems">
                                    <div class="empty-cart" style="text-align: center; padding: 40px 20px; color: var(--text-light);">
                                        <i class="fas fa-shopping-cart" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                                        <p>Your cart is empty</p>
                                        <p style="font-size: 14px;">Add products from the left side</p>
                                    </div>
                                </div>
                                
                                <div class="cart-footer">
                                    <div class="cart-summary">
                                        <div class="summary-row">
                                            <span>Subtotal:</span>
                                            <span id="cartSubtotal">₱0.00</span>
                                        </div>
                                        <div class="summary-row">
                                            <span>Tax (0%):</span>
                                            <span id="cartTax">₱0.00</span>
                                        </div>
                                        <div class="summary-row total">
                                            <span>Total:</span>
                                            <span id="cartTotal">₱0.00</span>
                                        </div>
                                    </div>
                                    
                                    <div class="cart-actions">
                                        <button class="btn btn-danger" id="clearCartBtn">
                                            <i class="fas fa-trash"></i> Clear Cart
                                        </button>
                                        <button class="btn btn-success" id="checkoutBtn">
                                            <i class="fas fa-check-circle"></i> Complete Sale
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Products Page -->
                <div id="productsPage" class="page" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title">Products Management</h2>
                        <button class="btn btn-primary" id="addProductBtn">
                            <i class="fas fa-plus"></i> Add Product
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="productsTable">
                                <tr>
                                    <td colspan="5" class="text-center">No products available</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Sales Page -->
                <div id="salesPage" class="page" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title">Sales History</h2>
                        <div class="filter-controls">
                            <div class="filter-group">
                                <label class="filter-label">Date Range:</label>
                                <input type="date" id="salesStartDate">
                                <span>to</span>
                                <input type="date" id="salesEndDate">
                            </div>
                            <button class="btn btn-secondary" id="filterSalesBtn">
                                <i class="fas fa-filter"></i> Filter
                            </button>
                            <button class="btn btn-primary" id="resetSalesFilterBtn">
                                <i class="fas fa-redo"></i> Reset
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Transaction ID</th>
                                    <th>Items</th>
                                    <th>Total Cost</th>
                                    <th>Total Sales</th>
                                    <th>Net Profit</th>
                                </tr>
                            </thead>
                            <tbody id="salesTable">
                                <tr>
                                    <td colspan="6" class="text-center">No sales records available</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Reports Page -->
                <div id="reportsPage" class="page" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title">Income Reports</h2>
                        <button class="btn btn-primary" id="generateReportBtn">
                            <i class="fas fa-file-pdf"></i> Generate PDF Report
                        </button>
                    </div>
                    
                    <div class="filter-controls">
                        <div class="filter-group">
                            <label class="filter-label">Report Period:</label>
                            <select id="reportPeriod">
                                <option value="today">Today</option>
                                <option value="specificDate">Specific Date</option>
                                <option value="thisWeek">This Week</option>
                                <option value="specificWeek">Specific Week</option>
                                <option value="thisMonth">This Month</option>
                                <option value="specificMonth">Specific Month</option>
                                <option value="year">This Year</option>
                            </select>
                        </div>
                        
                        <div class="filter-group" id="specificDateGroup" style="display: none;">
                            <label class="filter-label">Select Date:</label>
                            <input type="date" id="specificDate">
                        </div>
                        
                        <div class="filter-group" id="specificWeekGroup" style="display: none;">
                            <label class="filter-label">Select Week:</label>
                            <input type="week" id="specificWeek">
                        </div>
                        
                        <div class="filter-group" id="specificMonthGroup" style="display: none;">
                            <label class="filter-label">Select Month:</label>
                            <input type="month" id="specificMonth">
                        </div>
                        
                        <button class="btn btn-secondary" id="generateReportDataBtn">
                            <i class="fas fa-chart-bar"></i> Generate Report
                        </button>
                    </div>
                    
                    <div class="dashboard-cards" id="reportCards">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Total Sales</h3>
                                <div class="card-icon sales">
                                    <i class="fas fa-shopping-cart"></i>
                                </div>
                            </div>
                            <div class="card-value" id="reportSales">₱0.00</div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Total Income</h3>
                                <div class="card-icon income">
                                    <i class="fas fa-money-bill-wave"></i>
                                </div>
                            </div>
                            <div class="card-value" id="reportIncome">₱0.00</div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Total Cost</h3>
                                <div class="card-icon profit">
                                    <i class="fas fa-hand-holding-usd"></i>
                                </div>
                            </div>
                            <div class="card-value" id="reportPuhunan">₱0.00</div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Net Profit</h3>
                                <div class="card-icon profit">
                                    <i class="fas fa-chart-pie"></i>
                                </div>
                            </div>
                            <div class="card-value" id="reportProfit">₱0.00</div>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Transaction Count</th>
                                    <th>Total Sales</th>
                                    <th>Total Cost</th>
                                    <th>Net Profit</th>
                                    <th>Profit Margin</th>
                                </tr>
                            </thead>
                            <tbody id="reportTable">
                                <tr>
                                    <td colspan="6" class="text-center">Select a report period and click "Generate Report"</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Settings Page -->
                <div id="settingsPage" class="page" style="display: none;">
                    <div class="settings-container">
                        <div class="settings-nav">
                            <ul>
                                <li><a href="#" data-settings="profile" class="active"><i class="fas fa-user"></i> Profile</a></li>
                                <li><a href="#" data-settings="security"><i class="fas fa-shield-alt"></i> Security</a></li>
                                <li><a href="#" data-settings="preferences"><i class="fas fa-palette"></i> Preferences</a></li>
                            </ul>
                        </div>
                        
                        <div class="settings-content">
                            <!-- Profile Settings -->
                            <div id="profileSettings" class="settings-section">
                                <h2 class="section-title">Profile Settings</h2>
                                
                                <div class="avatar-upload">
                                    <div class="avatar-preview" id="avatarPreview">
                                        <span id="avatarPreviewText">U</span>
                                        <img id="avatarPreviewImage" style="display: none;" alt="Profile">
                                    </div>
                                    <div class="avatar-upload-actions">
                                        <input type="file" id="avatarUpload" accept="image/*" style="display: none;">
                                        <button class="btn btn-secondary" id="uploadAvatarBtn">
                                            <i class="fas fa-upload"></i> Upload Photo
                                        </button>
                                        <p style="margin-top: 10px; font-size: 14px; color: var(--text-light);">Max size: 2MB. Image will be converted to Base64.</p>
                                    </div>
                                </div>
                                
                                <form id="profileForm">
                                    <div class="form-group">
                                        <label class="form-label" for="profileName">Full Name</label>
                                        <input type="text" id="profileName" placeholder="Enter your full name" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label" for="profileEmail">Email Address</label>
                                        <input type="email" id="profileEmail" placeholder="Enter your email" required readonly>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Save Changes
                                    </button>
                                </form>
                            </div>
                            
                            <!-- Security Settings -->
                            <div id="securitySettings" class="settings-section" style="display: none;">
                                <h2 class="section-title">Security Settings</h2>
                                
                                <form id="passwordForm">
                                    <div class="form-group">
                                        <label class="form-label" for="currentPassword">Current Password</label>
                                        <input type="password" id="currentPassword" placeholder="Enter your current password" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label" for="newPassword">New Password</label>
                                        <input type="password" id="newPassword" placeholder="Enter new password" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label" for="confirmNewPassword">Confirm New Password</label>
                                        <input type="password" id="confirmNewPassword" placeholder="Confirm new password" required>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-key"></i> Change Password
                                    </button>
                                </form>
                            </div>
                            
                            <!-- Preferences Settings -->
                            <div id="preferencesSettings" class="settings-section" style="display: none;">
                                <h2 class="section-title">Preferences</h2>
                                
                                <div class="form-group">
                                    <label class="form-label">Theme Mode</label>
                                    <div style="display: flex; gap: 15px; margin-top: 10px;">
                                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                            <input type="radio" name="themeMode" value="light" checked>
                                            <i class="fas fa-sun"></i> Light Mode
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                            <input type="radio" name="themeMode" value="dark">
                                            <i class="fas fa-moon"></i> Dark Mode
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                            <input type="radio" name="themeMode" value="auto">
                                            <i class="fas fa-adjust"></i> Auto
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Notification Settings</label>
                                    <div style="margin-top: 10px;">
                                        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; cursor: pointer;">
                                            <input type="checkbox" id="notifySales" checked>
                                            <span>Notify on completed sales</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; cursor: pointer;">
                                            <input type="checkbox" id="notifyLowStock" checked>
                                            <span>Notify on low product stock</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                            <input type="checkbox" id="notifyReports" checked>
                                            <span>Notify when reports are generated</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <button class="btn btn-primary" id="savePreferencesBtn">
                                    <i class="fas fa-save"></i> Save Preferences
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <footer class="footer">
                <p>Powered by: <strong>Wxyz Development</strong> | <strong>Steven Macapañas</strong></p>
            </footer>
        </div>
    </div>

    <!-- Product Modal -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="productModalTitle">Add New Product</h3>
                <button class="modal-close" id="closeProductModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    
                    <div class="form-group">
                        <label class="form-label" for="productName">Product Name</label>
                        <input type="text" id="productName" placeholder="Enter product name" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="productCategory">Category</label>
                            <select id="productCategory" required>
                                <option value="">Select Category</option>
                                <option value="noodles">Noodles</option>
                                <option value="sauce">Sauce</option>
                                <option value="snacks">Snacks</option>
                                <option value="beverages">Beverages</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="productPrice">Price (₱)</label>
                            <input type="number" id="productPrice" placeholder="0.00" min="0" step="0.01" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="productStock">Stock Quantity</label>
                            <input type="number" id="productStock" placeholder="0" min="0" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="productCost">Cost (per unit)</label>
                            <input type="number" id="productCost" placeholder="0.00" min="0" step="0.01" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="productDescription">Description (Optional)</label>
                        <textarea id="productDescription" rows="3" placeholder="Enter product description"></textarea>
                    </div>
                    
                    <!-- Product Image Upload -->
                    <div class="form-group">
                        <label class="form-label" for="productImage">Product Image</label>
                        <input type="file" id="productImage" accept="image/*" style="display: none;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <button type="button" class="btn btn-secondary" id="chooseImageBtn" style="width: auto;">
                                <i class="fas fa-image"></i> Choose Image
                            </button>
                            <span id="imageFileName" style="font-size: 14px; color: var(--text-light);">No image selected</span>
                        </div>
                        <div id="imagePreview" style="margin-top: 10px; display: none;">
                            <img id="previewImage" style="max-width: 100%; max-height: 200px; border-radius: var(--radius); border: 1px solid var(--border);">
                        </div>
                        <p style="margin-top: 5px; font-size: 12px; color: var(--text-light);">Max size: 2MB. Image will be stored as Base64.</p>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelProductBtn">Cancel</button>
                <button class="btn btn-primary" id="saveProductBtn">Save Product</button>
            </div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div class="modal" id="checkoutModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Complete Sale</h3>
                <button class="modal-close" id="closeCheckoutModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Payment Amount (₱)</label>
                    <input type="number" id="paymentAmount" placeholder="0.00" min="0" step="0.01" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Change (₱)</label>
                    <input type="number" id="changeAmount" placeholder="0.00" readonly>
                </div>
                
                <div class="summary-row">
                    <span>Total Amount:</span>
                    <span id="checkoutTotal">₱0.00</span>
                </div>
                
                <div class="summary-row total">
                    <span>Net Profit:</span>
                    <span id="checkoutProfit">₱0.00</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelCheckoutBtn">Cancel</button>
                <button class="btn btn-success" id="confirmCheckoutBtn">Complete Sale</button>
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div class="modal" id="receiptModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Print Receipt</h3>
                <button class="modal-close" id="closeReceiptModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="receiptContent" style="font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.4;">
                    <!-- Receipt content will be generated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="skipReceiptBtn">Skip Receipt</button>
                <button class="btn btn-primary" id="printReceiptBtn">
                    <i class="fas fa-print"></i> Print Receipt
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; display: none;">
        <div style="font-size: 24px; margin-bottom: 20px;"><i class="fas fa-spinner fa-spin"></i></div>
        <div id="loadingMessage">Loading...</div>
    </div>

<!-- Delete Confirmation Modal -->
<div class="modal" id="deleteModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Confirm Delete</h3>
            <button class="modal-close" id="closeDeleteModal">&times;</button>
        </div>
        <div class="modal-body">
            <div style="text-align: center; padding: 20px 0;">
                <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--warning); margin-bottom: 20px;"></i>
                <h3 id="deleteProductName" style="margin-bottom: 10px;">Product Name</h3>
                <p style="color: var(--text-light); margin-bottom: 20px;">Are you sure you want to delete this product? This action cannot be undone.</p>
                
                <div style="background-color: var(--background-alt); padding: 15px; border-radius: var(--radius); margin-bottom: 20px;">
                    <p style="margin-bottom: 8px; font-weight: 500;">Product Details:</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                        <div>
                            <span style="color: var(--text-light);">Category:</span>
                            <span id="deleteProductCategory" style="font-weight: 500; margin-left: 5px;"></span>
                        </div>
                        <div>
                            <span style="color: var(--text-light);">Price:</span>
                            <span id="deleteProductPrice" style="font-weight: 500; margin-left: 5px;"></span>
                        </div>
                        <div>
                            <span style="color: var(--text-light);">Stock:</span>
                            <span id="deleteProductStock" style="font-weight: 500; margin-left: 5px;"></span>
                        </div>
                        <div>
                            <span style="color: var(--text-light);">Cost:</span>
                            <span id="deleteProductCost" style="font-weight: 500; margin-left: 5px;"></span>
                        </div>
                    </div>
                </div>
                
                <div style="background-color: var(--warning); color: white; padding: 15px; border-radius: var(--radius);">
                    <p style="margin: 0; font-size: 14px;">
                        <i class="fas fa-exclamation-circle"></i> 
                        <strong>Warning:</strong> Deleting this product will also remove it from any sales history reports.
                    </p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="cancelDeleteBtn">Cancel</button>
            <button class="btn btn-danger" id="confirmDeleteBtn">
                <i class="fas fa-trash"></i> Delete Product
            </button>
        </div>
    </div>
</div>


    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAvik9Nv_RJwjnM1ai6VwOtawuu7Z7aajY",
            authDomain: "ziamyang-84c9d.firebaseapp.com",
            projectId: "ziamyang-84c9d",
            storageBucket: "ziamyang-84c9d.firebasestorage.app",
            messagingSenderId: "814923464012",
            appId: "1:814923464012:web:bd71f33e5425199af963e9",
            measurementId: "G-TN6QK2F775"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global State
        const state = {
            currentUser: null,
            userData: null,
            cart: [],
            products: [],
            sales: [],
            currentPage: 'dashboard',
            theme: 'light',
            currentProductImage: null
        };

        // DOM Elements
        const authPage = document.getElementById('authPage');
        const appContainer = document.getElementById('appContainer');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');
        const themeToggle = document.getElementById('themeToggle');
        const fullscreenToggle = document.getElementById('fullscreenToggle');
        const logoutBtn = document.getElementById('logoutBtn');
        const userProfile = document.getElementById('userProfile');
        const userName = document.getElementById('userName');
        const userAvatar = document.getElementById('userAvatar');
        const avatarInitials = document.getElementById('avatarInitials');
        const avatarImage = document.getElementById('avatarImage');
        const pageTitle = document.getElementById('pageTitle');
        const pageContent = document.getElementById('pageContent');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingMessage = document.getElementById('loadingMessage');
        const toastContainer = document.getElementById('toastContainer');

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            setupEventListeners();
            checkAuthState();
        });

        // Initialize App Functionality
        function initializeApp() {
            // Check for saved theme
            const savedTheme = localStorage.getItem('ziamyang-theme') || 'light';
            setTheme(savedTheme);
            
            // Set theme toggle icon
            updateThemeToggleIcon(savedTheme);
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Auth Tab Toggles
            document.getElementById('loginTab').addEventListener('click', () => switchAuthTab('login'));
            document.getElementById('signupTab').addEventListener('click', () => switchAuthTab('signup'));
            
            // Auth Forms
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('signupForm').addEventListener('submit', handleSignup);
            document.getElementById('googleSignIn').addEventListener('click', handleGoogleSignIn);
            
            // App Navigation
            document.querySelectorAll('.sidebar-nav a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = e.target.closest('a').getAttribute('data-page');
                    navigateToPage(page);
                });
            });
            
            // User Menu
            document.querySelectorAll('.user-menu a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = e.target.closest('a').getAttribute('data-page');
                    if (page) navigateToPage(page);
                });
            });
            
            // Logout
            logoutBtn.addEventListener('click', handleLogout);
            
            // Sidebar Toggle
            sidebarToggle.addEventListener('click', () => sidebar.classList.toggle('active'));
            
            // Theme Toggle
            themeToggle.addEventListener('click', toggleTheme);
            
            // Fullscreen Toggle
            fullscreenToggle.addEventListener('click', toggleFullscreen);
            
            // Dashboard buttons
            document.getElementById('viewAllSales').addEventListener('click', () => navigateToPage('sales'));
            
            // POS Page
            document.getElementById('categoryFilter').addEventListener('change', filterProducts);
            document.getElementById('clearCartBtn').addEventListener('click', clearCart);
            document.getElementById('checkoutBtn').addEventListener('click', openCheckoutModal);
            
            // Products Page
            document.getElementById('addProductBtn').addEventListener('click', openProductModal);

            // ✅ ADD DELETE MODAL LISTENERS HERE (after product modal listeners)
            document.getElementById('closeDeleteModal').addEventListener('click', closeDeleteModal);
            document.getElementById('cancelDeleteBtn').addEventListener('click', closeDeleteModal);
            document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
            if (productToDelete) {
                deleteProduct(productToDelete.id);
                }
            });
            
            // Sales Page
            document.getElementById('filterSalesBtn').addEventListener('click', filterSales);
            document.getElementById('resetSalesFilterBtn').addEventListener('click', resetSalesFilter);
            
            // Reports Page
            document.getElementById('reportPeriod').addEventListener('change', handleReportPeriodChange);
            document.getElementById('generateReportDataBtn').addEventListener('click', generateReportData);
            document.getElementById('generateReportBtn').addEventListener('click', generatePDFReport);
            
            // Settings Page
            document.querySelectorAll('.settings-nav a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const settings = e.target.closest('a').getAttribute('data-settings');
                    switchSettingsTab(settings);
                });
            });
            
            document.getElementById('uploadAvatarBtn').addEventListener('click', () => document.getElementById('avatarUpload').click());
            document.getElementById('avatarUpload').addEventListener('change', handleAvatarUpload);
            document.getElementById('profileForm').addEventListener('submit', updateProfile);
            document.getElementById('passwordForm').addEventListener('submit', changePassword);
            document.getElementById('savePreferencesBtn').addEventListener('click', savePreferences);
            
            // Product Modal
            document.getElementById('closeProductModal').addEventListener('click', closeProductModal);
            document.getElementById('cancelProductBtn').addEventListener('click', closeProductModal);
            document.getElementById('saveProductBtn').addEventListener('click', saveProduct);
            document.getElementById('chooseImageBtn').addEventListener('click', () => document.getElementById('productImage').click());
            document.getElementById('productImage').addEventListener('change', handleProductImageUpload);
            
            // Checkout Modal
            document.getElementById('closeCheckoutModal').addEventListener('click', closeCheckoutModal);
            document.getElementById('cancelCheckoutBtn').addEventListener('click', closeCheckoutModal);
            document.getElementById('paymentAmount').addEventListener('input', calculateChange);
            document.getElementById('confirmCheckoutBtn').addEventListener('click', completeSale);
            
            // Receipt Modal
            document.getElementById('closeReceiptModal').addEventListener('click', closeReceiptModal);
            document.getElementById('skipReceiptBtn').addEventListener('click', closeReceiptModal);
            document.getElementById('printReceiptBtn').addEventListener('click', printReceipt);
            
            // Fullscreen change events
            document.addEventListener('fullscreenchange', updateFullscreenIcon);
            document.addEventListener('webkitfullscreenchange', updateFullscreenIcon);
            document.addEventListener('msfullscreenchange', updateFullscreenIcon);
        }

        // Toast Notification System
        function showToast(type, title, message, duration = 5000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = 'fas fa-info-circle';
            switch(type) {
                case 'success': icon = 'fas fa-check-circle'; break;
                case 'error': icon = 'fas fa-exclamation-circle'; break;
                case 'warning': icon = 'fas fa-exclamation-triangle'; break;
                default: icon = 'fas fa-info-circle';
            }
            
            toast.innerHTML = `
                <i class="${icon}"></i>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close">&times;</button>
            `;
            
            toastContainer.appendChild(toast);
            
            // Show toast with animation
            setTimeout(() => toast.classList.add('show'), 10);
            
            // Close button
            toast.querySelector('.toast-close').addEventListener('click', () => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            });
            
            // Auto dismiss
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }
            }, duration);
        }

        // Loading Overlay
        function showLoading(message = 'Loading...') {
            loadingMessage.textContent = message;
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        // Auth Functions
        function switchAuthTab(tab) {
            const loginTab = document.getElementById('loginTab');
            const signupTab = document.getElementById('signupTab');
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            
            if (tab === 'login') {
                loginTab.classList.add('active');
                signupTab.classList.remove('active');
                loginForm.style.display = 'block';
                signupForm.style.display = 'none';
            } else {
                loginTab.classList.remove('active');
                signupTab.classList.add('active');
                loginForm.style.display = 'none';
                signupForm.style.display = 'block';
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            showLoading('Signing in...');
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                showToast('success', 'Success', 'Login successful!');
            } catch (error) {
                console.error('Login error:', error);
                showToast('error', 'Login Failed', error.message);
                hideLoading();
            }
        }

        async function handleSignup(e) {
            e.preventDefault();
            showLoading('Creating account...');
            
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (password !== confirmPassword) {
                showToast('error', 'Signup Failed', 'Passwords do not match');
                hideLoading();
                return;
            }
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Create user document in Firestore
                await db.collection('users').doc(user.uid).set({
                    name: name,
                    email: email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    preferences: {
                        theme: 'light',
                        notifications: {
                            sales: true,
                            lowStock: true,
                            reports: true
                        }
                    }
                });
                
                showToast('success', 'Success', 'Account created successfully!');
            } catch (error) {
                console.error('Signup error:', error);
                showToast('error', 'Signup Failed', error.message);
                hideLoading();
            }
        }

        async function handleGoogleSignIn() {
            showLoading('Signing in with Google...');
            
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
                showToast('success', 'Success', 'Google login successful!');
            } catch (error) {
                console.error('Google sign in error:', error);
                showToast('error', 'Google Sign In Failed', error.message);
                hideLoading();
            }
        }

        async function handleLogout() {
            showLoading('Logging out...');
            
            try {
                await auth.signOut();
                showToast('success', 'Logged Out', 'You have been logged out successfully');
                navigateToAuth();
            } catch (error) {
                console.error('Logout error:', error);
                showToast('error', 'Logout Failed', error.message);
                hideLoading();
            }
        }

        // Auth State Observer
        function checkAuthState() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // User is signed in
                    state.currentUser = user;
                    
                    // Get user data from Firestore
                    try {
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        
                        if (userDoc.exists) {
                            state.userData = userDoc.data();
                            
                            // Apply user preferences
                            if (state.userData.preferences && state.userData.preferences.theme) {
                                setTheme(state.userData.preferences.theme);
                            }
                            
                            // Update UI with user data
                            updateUserUI();
                        } else {
                            // Create user document if it doesn't exist
                            await db.collection('users').doc(user.uid).set({
                                name: user.displayName || 'User',
                                email: user.email,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                preferences: {
                                    theme: 'light',
                                    notifications: {
                                        sales: true,
                                        lowStock: true,
                                        reports: true
                                    }
                                }
                            });
                            
                            state.userData = {
                                name: user.displayName || 'User',
                                email: user.email
                            };
                            updateUserUI();
                        }
                    } catch (error) {
                        console.error('Error getting user data:', error);
                        state.userData = {
                            name: user.displayName || 'User',
                            email: user.email
                        };
                        updateUserUI();
                    }
                    
                    // Load app data
                    await loadAppData();
                    
                    // Navigate to app
                    navigateToApp();
                } else {
                    // User is signed out
                    state.currentUser = null;
                    state.userData = null;
                    navigateToAuth();
                }
                
                hideLoading();
            });
        }

        // Update User UI
        function updateUserUI() {
            if (!state.currentUser || !state.userData) return;
            
            // Update user name
            const displayName = state.userData.name || state.currentUser.displayName || 'User';
            userName.textContent = displayName;
            
            // Update user avatar
            const initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            avatarInitials.textContent = initials;
            
            // Check for avatar image
            if (state.userData.avatar) {
                avatarImage.src = state.userData.avatar;
                avatarImage.style.display = 'block';
                avatarInitials.style.display = 'none';
                
                // Update avatar preview in settings
                const avatarPreviewImage = document.getElementById('avatarPreviewImage');
                const avatarPreviewText = document.getElementById('avatarPreviewText');
                if (avatarPreviewImage && avatarPreviewText) {
                    avatarPreviewImage.src = state.userData.avatar;
                    avatarPreviewImage.style.display = 'block';
                    avatarPreviewText.style.display = 'none';
                }
            }
            
            // Update profile form
            document.getElementById('profileName').value = displayName;
            document.getElementById('profileEmail').value = state.currentUser.email || '';
            
            // Update settings preferences
            if (state.userData.preferences) {
                const themeMode = document.querySelector(`input[name="themeMode"][value="${state.userData.preferences.theme || 'light'}"]`);
                if (themeMode) themeMode.checked = true;
                
                if (state.userData.preferences.notifications) {
                    document.getElementById('notifySales').checked = state.userData.preferences.notifications.sales !== false;
                    document.getElementById('notifyLowStock').checked = state.userData.preferences.notifications.lowStock !== false;
                    document.getElementById('notifyReports').checked = state.userData.preferences.notifications.reports !== false;
                }
            }
        }

        // Navigation Functions
        function navigateToAuth() {
            authPage.style.display = 'flex';
            appContainer.style.display = 'none';
            
            // Reset auth forms
            document.getElementById('loginForm').reset();
            document.getElementById('signupForm').reset();
            switchAuthTab('login');
        }

        function navigateToApp() {
            authPage.style.display = 'none';
            appContainer.style.display = 'flex';
            
            // Load initial page
            navigateToPage(state.currentPage || 'dashboard');
        }

        function navigateToPage(page) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
            
            // Remove active class from all nav links
            document.querySelectorAll('.sidebar-nav a').forEach(link => link.classList.remove('active'));
            document.querySelectorAll('.user-menu a').forEach(link => link.classList.remove('active'));
            
            // Show selected page
            const pageElement = document.getElementById(`${page}Page`);
            if (pageElement) {
                pageElement.style.display = 'block';
                state.currentPage = page;
                
                // Update page title
                const titles = {
                    dashboard: 'Dashboard',
                    pos: 'POS System',
                    products: 'Products',
                    sales: 'Sales History',
                    reports: 'Income Reports',
                    settings: 'Settings'
                };
                pageTitle.textContent = titles[page] || 'Dashboard';
                
                // Update active nav link
                const navLink = document.querySelector(`.sidebar-nav a[data-page="${page}"]`);
                if (navLink) navLink.classList.add('active');
                
                // Load page-specific data
                switch(page) {
                    case 'dashboard':
                        loadDashboardData();
                        break;
                    case 'pos':
                        loadProductsForPOS();
                        break;
                    case 'products':
                        loadProductsForManagement();
                        break;
                    case 'sales':
                        loadSalesData();
                        break;
                    case 'reports':
                        resetReportUI();
                        break;
                    case 'settings':
                        switchSettingsTab('profile');
                        break;
                }
            }
            
            // Close sidebar on mobile
            if (window.innerWidth <= 1024) {
                sidebar.classList.remove('active');
            }
        }

        // Theme Functions
        function setTheme(theme) {
            state.theme = theme;
            
            if (theme === 'dark' || (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            
            // Save to localStorage
            localStorage.setItem('ziamyang-theme', theme);
            
            // Update theme toggle icon
            updateThemeToggleIcon(theme);
        }

        function toggleTheme() {
            const currentTheme = localStorage.getItem('ziamyang-theme') || 'light';
            let newTheme;
            
            if (currentTheme === 'light') {
                newTheme = 'dark';
            } else if (currentTheme === 'dark') {
                newTheme = 'auto';
            } else {
                newTheme = 'light';
            }
            
            setTheme(newTheme);
            
            // Save to user preferences if logged in
            if (state.userData && state.currentUser) {
                db.collection('users').doc(state.currentUser.uid).update({
                    'preferences.theme': newTheme
                }).then(() => {
                    state.userData.preferences.theme = newTheme;
                }).catch(error => {
                    console.error('Error updating theme preference:', error);
                });
            }
        }

        function updateThemeToggleIcon(theme) {
            const icon = themeToggle.querySelector('i');
            
            if (theme === 'dark') {
                icon.className = 'fas fa-sun';
            } else if (theme === 'auto') {
                icon.className = 'fas fa-adjust';
            } else {
                icon.className = 'fas fa-moon';
            }
        }

        // Fullscreen Functions
        function toggleFullscreen() {
            const icon = fullscreenToggle.querySelector('i');
            
            if (!document.fullscreenElement) {
                // Enter fullscreen
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                } else if (document.documentElement.webkitRequestFullscreen) {
                    document.documentElement.webkitRequestFullscreen();
                } else if (document.documentElement.msRequestFullscreen) {
                    document.documentElement.msRequestFullscreen();
                }
                
                icon.className = 'fas fa-compress';
                showToast('info', 'Fullscreen', 'Entered fullscreen mode');
            } else {
                // Exit fullscreen
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                
                icon.className = 'fas fa-expand';
                showToast('info', 'Fullscreen', 'Exited fullscreen mode');
            }
        }

        function updateFullscreenIcon() {
            const icon = fullscreenToggle.querySelector('i');
            
            if (document.fullscreenElement || 
                document.webkitFullscreenElement || 
                document.msFullscreenElement) {
                icon.className = 'fas fa-compress';
            } else {
                icon.className = 'fas fa-expand';
            }
        }

        // Load App Data
        async function loadAppData() {
            showLoading('Loading data...');
            
            try {
                // Load products with error handling
                const productsSnapshot = await db.collection('products').orderBy('name').get();
                state.products = productsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Load recent sales
                const salesSnapshot = await db.collection('sales')
                    .orderBy('timestamp', 'desc')
                    .limit(10)
                    .get();
                state.sales = salesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                hideLoading();
                showToast('success', 'Data Loaded', 'App data loaded successfully');
            } catch (error) {
                console.error('Error loading app data:', error);
                console.error('Error code:', error.code);
                
                // Continue with empty arrays if there's an error
                state.products = [];
                state.sales = [];
                
                hideLoading();
                
                // Only show error if it's not permission-related (might be expected for new users)
                if (error.code !== 'permission-denied') {
                    showToast('error', 'Data Load Error', 'Failed to load data. Please refresh the page.');
                } else {
                    showToast('info', 'No Data', 'No products found. Add your first product!');
                }
            }
        }

        // Dashboard Functions
        async function loadDashboardData() {
            try {
                // Calculate today's date range
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                // Get today's sales
                const todaySalesSnapshot = await db.collection('sales')
                    .where('timestamp', '>=', today)
                    .where('timestamp', '<', tomorrow)
                    .get();
                
                let todaySales = 0;
                let todayProfit = 0;
                todaySalesSnapshot.forEach(doc => {
                    const sale = doc.data();
                    todaySales += sale.totalAmount || 0;
                    todayProfit += sale.netProfit || 0;
                });
                
                // Get yesterday's sales for comparison
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdaySalesSnapshot = await db.collection('sales')
                    .where('timestamp', '>=', yesterday)
                    .where('timestamp', '<', today)
                    .get();
                
                let yesterdaySales = 0;
                yesterdaySalesSnapshot.forEach(doc => {
                    const sale = doc.data();
                    yesterdaySales += sale.totalAmount || 0;
                });
                
                // Calculate sales change
                let salesChange = 0;
                if (yesterdaySales > 0) {
                    salesChange = ((todaySales - yesterdaySales) / yesterdaySales) * 100;
                } else if (todaySales > 0) {
                    salesChange = 100;
                }
                
                // Update dashboard cards
                document.getElementById('todaySales').textContent = `₱${todaySales.toFixed(2)}`;
                document.getElementById('totalIncome').textContent = `₱${todaySales.toFixed(2)}`;
                document.getElementById('netProfit').textContent = `₱${todayProfit.toFixed(2)}`;
                document.getElementById('totalProducts').textContent = state.products.length;
                
                // Update change indicators
                const todaySalesChangeEl = document.getElementById('todaySalesChange');
                todaySalesChangeEl.textContent = `${salesChange >= 0 ? '+' : ''}${salesChange.toFixed(1)}% from yesterday`;
                todaySalesChangeEl.className = `card-change ${salesChange >= 0 ? 'positive' : 'negative'}`;
                
                // Update recent sales table
                updateRecentSalesTable();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        function updateRecentSalesTable() {
            const tableBody = document.getElementById('recentSalesTable');
            
            if (state.sales.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">No recent sales</td></tr>';
                return;
            }
            
            tableBody.innerHTML = '';
            state.sales.slice(0, 5).forEach(sale => {
                const date = sale.timestamp ? sale.timestamp.toDate() : new Date();
                const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${sale.id.substring(0, 8)}</td>
                    <td>${sale.items ? sale.items.length : 0} items</td>
                    <td>₱${sale.totalAmount ? sale.totalAmount.toFixed(2) : '0.00'}</td>
                    <td>₱${sale.netProfit ? sale.netProfit.toFixed(2) : '0.00'}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // POS Functions
        function loadProductsForPOS() {
            const productsGrid = document.getElementById('productsGrid');
            productsGrid.innerHTML = '';
            
            if (state.products.length === 0) {
                productsGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-light);"><i class="fas fa-box-open" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i><p>No products available. Add products from the Products page.</p></div>';
                return;
            }
            
            state.products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.dataset.id = product.id;
                productCard.dataset.category = product.category || 'other';
                
                // Use image if available, otherwise use icon
                let imageHTML = `<i class="fas fa-utensils"></i>`;
                if (product.image) {
                    imageHTML = `<img src="${product.image}" alt="${product.name}" style="width: 100%; height: 100%; object-fit: cover;">`;
                }
                
                productCard.innerHTML = `
                    <div class="product-image">
                        ${imageHTML}
                    </div>
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">₱${product.price ? product.price.toFixed(2) : '0.00'}</div>
                        <div class="product-stock">Stock: ${product.stock || 0}</div>
                    </div>
                `;
                
                productCard.addEventListener('click', () => addToCart(product));
                productsGrid.appendChild(productCard);
            });
            
            filterProducts(); // Apply initial filter
        }

        function filterProducts() {
            const selectedCategory = document.getElementById('categoryFilter').value;
            const productCards = document.querySelectorAll('.product-card');
            
            productCards.forEach(card => {
                if (selectedCategory === 'all' || card.dataset.category === selectedCategory) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function addToCart(product) {
            // Check if product is in stock
            if (product.stock <= 0) {
                showToast('warning', 'Out of Stock', `${product.name} is out of stock`);
                return;
            }
            
            // Check if product already in cart
            const existingItem = state.cart.find(item => item.id === product.id);
            
            if (existingItem) {
                // Check if we have enough stock
                if (existingItem.quantity >= product.stock) {
                    showToast('warning', 'Limited Stock', `Only ${product.stock} ${product.name} available`);
                    return;
                }
                existingItem.quantity++;
            } else {
                state.cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    cost: product.cost || 0,
                    quantity: 1,
                    stock: product.stock
                });
            }
            
            updateCartUI();
            showToast('success', 'Added to Cart', `${product.name} added to cart`);
        }

        function updateCartUI() {
            const cartItems = document.getElementById('cartItems');
            const emptyCart = document.querySelector('.empty-cart');
            
            if (state.cart.length === 0) {
                if (emptyCart) {
                    emptyCart.style.display = 'block';
                } else {
                    cartItems.innerHTML = `
                        <div class="empty-cart" style="text-align: center; padding: 40px 20px; color: var(--text-light);">
                            <i class="fas fa-shopping-cart" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                            <p>Your cart is empty</p>
                            <p style="font-size: 14px;">Add products from the left side</p>
                        </div>
                    `;
                }
            } else {
                // Remove empty cart message
                if (emptyCart) emptyCart.style.display = 'none';
                
                cartItems.innerHTML = '';
                state.cart.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    
                    const cartItem = document.createElement('div');
                    cartItem.className = 'cart-item';
                    cartItem.innerHTML = `
                        <div class="cart-item-info">
                            <div class="cart-item-name">${item.name}</div>
                            <div class="cart-item-price">₱${item.price.toFixed(2)} each</div>
                        </div>
                        <div class="cart-item-quantity">
                            <button class="quantity-btn decrease-btn" data-id="${item.id}">-</button>
                            <span>${item.quantity}</span>
                            <button class="quantity-btn increase-btn" data-id="${item.id}">+</button>
                        </div>
                        <div class="cart-item-total">₱${itemTotal.toFixed(2)}</div>
                    `;
                    
                    cartItems.appendChild(cartItem);
                });
                
                // Add event listeners to quantity buttons
                document.querySelectorAll('.decrease-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const productId = e.target.closest('button').dataset.id;
                        updateCartItemQuantity(productId, -1);
                    });
                });
                
                document.querySelectorAll('.increase-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const productId = e.target.closest('button').dataset.id;
                        updateCartItemQuantity(productId, 1);
                    });
                });
            }
            
            updateCartSummary();
        }

        function updateCartItemQuantity(productId, change) {
            const itemIndex = state.cart.findIndex(item => item.id === productId);
            
            if (itemIndex === -1) return;
            
            const item = state.cart[itemIndex];
            const newQuantity = item.quantity + change;
            
            if (newQuantity <= 0) {
                state.cart.splice(itemIndex, 1);
            } else if (newQuantity > item.stock) {
                showToast('warning', 'Limited Stock', `Only ${item.stock} ${item.name} available`);
                return;
            } else {
                state.cart[itemIndex].quantity = newQuantity;
            }
            
            updateCartUI();
        }

        function updateCartSummary() {
            let subtotal = 0;
            let totalCost = 0;
            
            state.cart.forEach(item => {
                subtotal += item.price * item.quantity;
                totalCost += (item.cost || 0) * item.quantity;
            });
            
            const tax = 0;
            const total = subtotal + tax;
            const profit = subtotal - totalCost;
            
            document.getElementById('cartSubtotal').textContent = `₱${subtotal.toFixed(2)}`;
            document.getElementById('cartTax').textContent = `₱${tax.toFixed(2)}`;
            document.getElementById('cartTotal').textContent = `₱${total.toFixed(2)}`;
            
            // Update checkout modal values
            document.getElementById('checkoutTotal').textContent = `₱${total.toFixed(2)}`;
            document.getElementById('checkoutProfit').textContent = `₱${profit.toFixed(2)}`;
            
            // Update payment amount field if open
            const paymentAmount = document.getElementById('paymentAmount');
            if (paymentAmount.value === '' || parseFloat(paymentAmount.value) < total) {
                paymentAmount.value = total.toFixed(2);
                calculateChange();
            }
        }

        function clearCart() {
            if (state.cart.length === 0) return;
            
            state.cart = [];
            updateCartUI();
            showToast('info', 'Cart Cleared', 'All items removed from cart');
        }

        function openCheckoutModal() {
            if (state.cart.length === 0) {
                showToast('warning', 'Empty Cart', 'Add items to cart before checkout');
                return;
            }
            
            document.getElementById('checkoutModal').classList.add('active');
        }

        function closeCheckoutModal() {
            document.getElementById('checkoutModal').classList.remove('active');
        }

        function calculateChange() {
            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value) || 0;
            const total = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const change = paymentAmount - total;
            
            document.getElementById('changeAmount').value = change >= 0 ? change.toFixed(2) : '0.00';
            
            // Style change amount
            const changeInput = document.getElementById('changeAmount');
            if (change < 0) {
                changeInput.style.color = 'var(--error)';
            } else {
                changeInput.style.color = 'var(--text)';
            }
        }

async function completeSale() {
    const paymentAmount = parseFloat(document.getElementById('paymentAmount').value) || 0;
    const total = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    
    // Calculate total cost automatically from product costs
    const totalCost = state.cart.reduce((sum, item) => sum + (item.cost || 0) * item.quantity, 0);
    const netProfit = total - totalCost;
    
    if (paymentAmount < total) {
        showToast('error', 'Insufficient Payment', `Payment amount must be at least ₱${total.toFixed(2)}`);
        return;
    }
    
    showLoading('Processing sale...');
    
    try {
        // Generate transaction ID
        const transactionId = 'TXN' + Date.now() + Math.floor(Math.random() * 1000);
        
        // Create current date for receipt (this will be used immediately)
        const currentDate = new Date();
        
        // Create sale record
        const saleData = {
            transactionId: transactionId,
            items: state.cart.map(item => ({
                productId: item.id,
                name: item.name,
                price: item.price,
                quantity: item.quantity,
                cost: item.cost || 0
            })),
            totalAmount: total,
            totalCost: totalCost,
            netProfit: netProfit,
            paymentAmount: paymentAmount,
            change: paymentAmount - total,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            timestampForReceipt: currentDate, // Add this for immediate use in receipt
            userId: state.currentUser.uid,
            userName: state.userData.name
        };
        
        // Save sale to Firestore
        await db.collection('sales').doc(transactionId).set(saleData);
        
        // Update product stock
        const batch = db.batch();
        state.cart.forEach(item => {
            const productRef = db.collection('products').doc(item.id);
            const product = state.products.find(p => p.id === item.id);
            
            if (product) {
                const newStock = product.stock - item.quantity;
                batch.update(productRef, { stock: newStock });
                
                // Update local state
                product.stock = newStock;
            }
        });
        
        await batch.commit();
        
        // Update local sales array (use currentDate for local display)
        state.sales.unshift({
            id: transactionId,
            ...saleData,
            timestamp: currentDate // Use actual date for local display
        });
        
        // Clear cart
        state.cart = [];
        updateCartUI();
        
        // Close modal
        closeCheckoutModal();
        
        // Show success message
        showToast('success', 'Sale Completed', `Transaction ${transactionId} completed successfully`);
        
        // Update dashboard if on dashboard
        if (state.currentPage === 'dashboard') {
            loadDashboardData();
        }
        
        hideLoading();
        
        // Generate and show receipt - use the currentDate we stored
        generateReceipt({
            ...saleData,
            timestamp: currentDate // Use the actual Date object for receipt
        });
        
    } catch (error) {
        console.error('Error completing sale:', error);
        console.error('Error details:', error.message);
        console.error('Error stack:', error.stack);
        showToast('error', 'Sale Failed', 'Failed to complete sale. Please try again.');
        hideLoading();
    }
}

function generateReceipt(saleData) {
    const receiptContent = document.getElementById('receiptContent');
    
    // Handle the timestamp - it could be a Firestore timestamp or a Date object
    let date;
    if (saleData.timestamp && typeof saleData.timestamp.toDate === 'function') {
        // It's a Firestore timestamp
        date = saleData.timestamp.toDate();
    } else if (saleData.timestamp instanceof Date) {
        // It's already a Date object
        date = saleData.timestamp;
    } else if (saleData.timestampForReceipt) {
        // Use the backup timestamp
        date = saleData.timestampForReceipt;
    } else {
        // Fallback to current date
        date = new Date();
    }
    
    const formattedDate = date.toLocaleDateString();
    const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    // Calculate item totals
    let receiptHTML = `
        <div style="text-align: center; margin-bottom: 15px;">
            <h3 style="margin: 0; color: var(--primary);">Ziamyang</h3>
            <p style="margin: 5px 0; font-size: 12px;">Your Go-To Spicy Fix</p>
            <p style="margin: 5px 0; font-size: 11px;">==============================</p>
        </div>
        
        <div style="margin-bottom: 10px;">
            <p style="margin: 3px 0;"><strong>Transaction ID:</strong> ${saleData.transactionId}</p>
            <p style="margin: 3px 0;"><strong>Date:</strong> ${formattedDate}</p>
            <p style="margin: 3px 0;"><strong>Time:</strong> ${formattedTime}</p>
            <p style="margin: 5px 0; font-size: 11px;">==============================</p>
        </div>
        
        <div style="margin-bottom: 10px;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th style="text-align: left; border-bottom: 1px dashed #ccc; padding: 5px 0;">Item</th>
                        <th style="text-align: center; border-bottom: 1px dashed #ccc; padding: 5px 0;">Qty</th>
                        <th style="text-align: right; border-bottom: 1px dashed #ccc; padding: 5px 0;">Price</th>
                        <th style="text-align: right; border-bottom: 1px dashed #ccc; padding: 5px 0;">Total</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    saleData.items.forEach(item => {
        const itemTotal = item.price * item.quantity;
        receiptHTML += `
            <tr>
                <td style="padding: 4px 0;">${item.name}</td>
                <td style="text-align: center; padding: 4px 0;">${item.quantity}</td>
                <td style="text-align: right; padding: 4px 0;">₱${item.price.toFixed(2)}</td>
                <td style="text-align: right; padding: 4px 0;">₱${itemTotal.toFixed(2)}</td>
            </tr>
        `;
    });
    
    receiptHTML += `
                </tbody>
            </table>
            <p style="margin: 5px 0; font-size: 11px;">==============================</p>
        </div>
        
        <div style="margin-bottom: 15px;">
            <p style="margin: 5px 0; display: flex; justify-content: space-between;">
                <span>Subtotal:</span>
                <span>₱${saleData.totalAmount.toFixed(2)}</span>
            </p>
            <p style="margin: 5px 0; display: flex; justify-content: space-between;">
                <span>Tax (0%):</span>
                <span>₱0.00</span>
            </p>
            <p style="margin: 5px 0; display: flex; justify-content: space-between;">
                <span>Payment:</span>
                <span>₱${saleData.paymentAmount.toFixed(2)}</span>
            </p>
            <p style="margin: 5px 0; display: flex; justify-content: space-between;">
                <span>Change:</span>
                <span>₱${saleData.change.toFixed(2)}</span>
            </p>
            <p style="margin: 10px 0 5px 0; display: flex; justify-content: space-between; font-weight: bold; border-top: 1px dashed #ccc; padding-top: 5px;">
                <span>TOTAL:</span>
                <span>₱${saleData.totalAmount.toFixed(2)}</span>
            </p>
            <p style="margin: 5px 0; font-size: 11px;">==============================</p>
        </div>
        
        <div style="text-align: center; font-size: 11px; color: var(--text-light);">
            <p style="margin: 5px 0;">Thank you for your purchase!</p>
            <p style="margin: 5px 0;">Please come again</p>
            <p style="margin: 5px 0;">Powered by: Wxyz Development</p>
        </div>
    `;
    
    receiptContent.innerHTML = receiptHTML;
    
    // Show receipt modal
    document.getElementById('receiptModal').classList.add('active');
}

        function closeReceiptModal() {
            document.getElementById('receiptModal').classList.remove('active');
        }

        function printReceipt() {
            const receiptContent = document.getElementById('receiptContent').innerHTML;
            const printWindow = window.open('', '_blank', 'width=400,height=600');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Receipt - Ziamyang</title>
                    <style>
                        body {
                            font-family: 'Courier New', monospace;
                            font-size: 14px;
                            line-height: 1.4;
                            padding: 10px;
                            margin: 0;
                            max-width: 300px;
                        }
                        @media print {
                            body { margin: 0; padding: 10px; }
                            @page { margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    ${receiptContent}
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() {
                                window.close();
                            }, 1000);
                        }
                    <\/script>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            closeReceiptModal();
        }

        // Product Management Functions
        function loadProductsForManagement() {
            const productsTable = document.getElementById('productsTable');
            
            if (state.products.length === 0) {
                productsTable.innerHTML = '<tr><td colspan="5" class="text-center">No products available</td></tr>';
                return;
            }
            
            productsTable.innerHTML = '';
            state.products.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div style="font-weight: 600;">${product.name}</div>
                        ${product.description ? `<div style="font-size: 13px; color: var(--text-light); margin-top: 4px;">${product.description}</div>` : ''}
                    </td>
                    <td>
                        <span style="text-transform: capitalize;">${product.category || 'other'}</span>
                    </td>
                    <td>₱${product.price ? product.price.toFixed(2) : '0.00'}</td>
                    <td>
                        <span class="${product.stock <= 5 ? 'error' : product.stock <= 10 ? 'warning' : 'success'}" style="color: ${product.stock <= 5 ? 'var(--error)' : product.stock <= 10 ? 'var(--warning)' : 'var(--success)'}">
                            ${product.stock || 0}
                        </span>
                    </td>
                    <td>
                        <div class="actions">
                            <button class="btn btn-secondary btn-sm edit-product" data-id="${product.id}">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-danger btn-sm delete-product" data-id="${product.id}">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </td>
                `;
                productsTable.appendChild(row);
            });
            
            // Add event listeners to edit/delete buttons
            document.querySelectorAll('.edit-product').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const productId = e.target.closest('button').dataset.id;
                    editProduct(productId);
                });
            });
            
// Update the delete button event listeners in the setupEventListeners function
document.querySelectorAll('.delete-product').forEach(btn => {
    btn.addEventListener('click', (e) => {
        const productId = e.target.closest('button').dataset.id;
        openDeleteModal(productId);
    });
});
        }

        // Product Image Handling
        function handleProductImageUpload(e) {
            const file = e.target.files[0];
            const imageFileName = document.getElementById('imageFileName');
            const imagePreview = document.getElementById('imagePreview');
            const previewImage = document.getElementById('previewImage');
            
            if (!file) {
                imageFileName.textContent = 'No image selected';
                imagePreview.style.display = 'none';
                state.currentProductImage = null;
                return;
            }
            
            // Check file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showToast('error', 'File Too Large', 'Please select an image smaller than 2MB');
                imageFileName.textContent = 'No image selected';
                imagePreview.style.display = 'none';
                state.currentProductImage = null;
                return;
            }
            
            // Check file type
            if (!file.type.match('image.*')) {
                showToast('error', 'Invalid File', 'Please select a valid image file');
                imageFileName.textContent = 'No image selected';
                imagePreview.style.display = 'none';
                state.currentProductImage = null;
                return;
            }
            
            // Update filename display
            imageFileName.textContent = file.name;
            
            // Preview image
            const reader = new FileReader();
            reader.onload = (event) => {
                previewImage.src = event.target.result;
                imagePreview.style.display = 'block';
                state.currentProductImage = event.target.result; // Store as Base64
            };
            reader.readAsDataURL(file);
        }

        function openProductModal(product = null) {
            const modal = document.getElementById('productModal');
            const title = document.getElementById('productModalTitle');
            const form = document.getElementById('productForm');
            
            // Reset the form
            form.reset();
            
            // Clear the hidden field manually
            const productIdField = document.getElementById('productId');
            if (productIdField) {
                productIdField.value = '';
            }
            
            // Reset image fields
            const imageFileName = document.getElementById('imageFileName');
            const imagePreview = document.getElementById('imagePreview');
            const previewImage = document.getElementById('previewImage');
            const productImageInput = document.getElementById('productImage');
            
            imageFileName.textContent = 'No image selected';
            imagePreview.style.display = 'none';
            productImageInput.value = '';
            state.currentProductImage = null;
            
            if (product) {
                // Edit mode
                title.textContent = 'Edit Product';
                document.getElementById('productId').value = product.id;
                
                // Set other fields
                document.getElementById('productName').value = product.name || '';
                document.getElementById('productCategory').value = product.category || 'noodles';
                document.getElementById('productPrice').value = product.price || '';
                document.getElementById('productStock').value = product.stock || '';
                document.getElementById('productCost').value = product.cost || '';
                document.getElementById('productDescription').value = product.description || '';
                
                // Handle product image if exists
                if (product.image) {
                    previewImage.src = product.image;
                    imagePreview.style.display = 'block';
                    imageFileName.textContent = 'Existing image loaded';
                    state.currentProductImage = product.image;
                }
            } else {
                // Add mode
                title.textContent = 'Add New Product';
                
                // Set defaults
                document.getElementById('productCategory').value = 'noodles';
                document.getElementById('productStock').value = 0;
                document.getElementById('productCost').value = 0;
            }
            
            modal.classList.add('active');
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.remove('active');
        }

        async function saveProduct() {
            // Get productId FIRST
            const productIdElement = document.getElementById('productId');
            const productId = productIdElement ? productIdElement.value : '';
            
            // Get other form values
            const name = document.getElementById('productName').value.trim();
            const category = document.getElementById('productCategory').value;
            const price = parseFloat(document.getElementById('productPrice').value) || 0;
            const stock = parseInt(document.getElementById('productStock').value) || 0;
            const cost = parseFloat(document.getElementById('productCost').value) || 0;
            const description = document.getElementById('productDescription').value.trim();
            
            // Validation
            if (!name || !category || price <= 0) {
                showToast('error', 'Validation Error', 'Please fill in all required fields with valid values');
                return;
            }
            
            if (!state.currentUser) {
                showToast('error', 'Authentication Required', 'You must be logged in to add products');
                return;
            }
            
            showLoading(productId ? 'Updating product...' : 'Adding product...');
            
            const productData = {
                name: name,
                category: category,
                price: price,
                stock: stock,
                cost: cost,
                description: description,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                userId: state.currentUser.uid,
                userEmail: state.currentUser.email
            };
            
            // Add image if exists
            if (state.currentProductImage) {
                productData.image = state.currentProductImage;
            }
            
            try {
                if (productId && productId.trim() !== '') {
                    // UPDATE existing product
                    const docRef = db.collection('products').doc(productId);
                    const docSnapshot = await docRef.get();
                    
                    if (docSnapshot.exists) {
                        await docRef.update(productData);
                        
                        // Update local state
                        const index = state.products.findIndex(p => p.id === productId);
                        if (index !== -1) {
                            state.products[index] = { ...state.products[index], ...productData };
                        }
                        
                        showToast('success', 'Product Updated', `${name} updated successfully`);
                    } else {
                        // Document doesn't exist, so add it as new
                        productData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        productData.createdBy = state.currentUser.uid;
                        
                        const newDocRef = await db.collection('products').add(productData);
                        
                        state.products.push({
                            id: newDocRef.id,
                            ...productData
                        });
                        
                        showToast('success', 'Product Added', `${name} added as new product`);
                    }
                } else {
                    // ADD NEW PRODUCT
                    productData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    productData.createdBy = state.currentUser.uid;
                    
                    const docRef = await db.collection('products').add(productData);
                    
                    state.products.push({
                        id: docRef.id,
                        ...productData
                    });
                    
                    showToast('success', 'Product Added', `${name} added successfully`);
                }
                
                // Close modal and refresh
                closeProductModal();
                loadProductsForManagement();
                
                if (state.currentPage === 'pos') {
                    loadProductsForPOS();
                }
                
                hideLoading();
            } catch (error) {
                console.error('Error saving product:', error);
                
                let errorMessage = 'Failed to save product.';
                
                if (error.code === 'not-found') {
                    errorMessage = `Product ID "${productId}" not found. This usually happens when trying to update a product that doesn't exist.`;
                } else if (error.code === 'permission-denied') {
                    errorMessage = 'Permission denied. Make sure you are logged in and Firestore rules allow writes.';
                } else if (error.code === 'invalid-argument') {
                    errorMessage = 'Invalid data. Please check all field values.';
                }
                
                showToast('error', 'Save Failed', errorMessage);
                hideLoading();
            }
        }

        function editProduct(productId) {
            const product = state.products.find(p => p.id === productId);
            if (product) {
                openProductModal(product);
            }
        }

        // Delete Modal Functions
let productToDelete = null;

function openDeleteModal(productId) {
    const product = state.products.find(p => p.id === productId);
    
    if (!product) {
        showToast('error', 'Product Not Found', 'The product you are trying to delete was not found.');
        return;
    }
    
    // Store the product to delete
    productToDelete = product;
    
    // Update modal content
    document.getElementById('deleteProductName').textContent = product.name;
    document.getElementById('deleteProductCategory').textContent = 
        product.category ? product.category.charAt(0).toUpperCase() + product.category.slice(1) : 'N/A';
    document.getElementById('deleteProductPrice').textContent = `₱${product.price ? product.price.toFixed(2) : '0.00'}`;
    document.getElementById('deleteProductStock').textContent = product.stock || 0;
    document.getElementById('deleteProductCost').textContent = `₱${product.cost ? product.cost.toFixed(2) : '0.00'}`;
    
    // Show warning if product has stock
    const warningElement = document.querySelector('#deleteModal .modal-body > div:last-child');
    if (product.stock > 0) {
        warningElement.innerHTML = `
            <p style="margin: 0; font-size: 14px;">
                <i class="fas fa-exclamation-circle"></i> 
                <strong>Warning:</strong> This product has ${product.stock} units in stock. 
                Deleting it will remove all inventory records.
            </p>
        `;
        warningElement.style.backgroundColor = 'var(--warning)';
    }
    
    // Show the modal
    document.getElementById('deleteModal').classList.add('active');
}

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.remove('active');
    productToDelete = null;
}

async function confirmDeleteProduct() {
    if (!productToDelete) {
        showToast('error', 'Error', 'No product selected for deletion.');
        return;
    }
    
    showLoading('Deleting product...');
    
    try {
        // Delete from Firestore
        await db.collection('products').doc(productToDelete.id).delete();
        
        // Remove from local state
        state.products = state.products.filter(p => p.id !== productToDelete.id);
        
        // Update UI
        loadProductsForManagement();
        
        // If on POS page, refresh product grid
        if (state.currentPage === 'pos') {
            loadProductsForPOS();
        }
        
        // Close modal
        closeDeleteModal();
        
        // Show success message
        showToast('success', 'Product Deleted', `${productToDelete.name} was deleted successfully.`);
        
        // Update dashboard if open
        if (state.currentPage === 'dashboard') {
            document.getElementById('totalProducts').textContent = state.products.length;
        }
        
        hideLoading();
        
    } catch (error) {
        console.error('Error deleting product:', error);
        
        let errorMessage = 'Failed to delete product. Please try again.';
        if (error.code === 'permission-denied') {
            errorMessage = 'You do not have permission to delete products.';
        } else if (error.code === 'not-found') {
            errorMessage = 'Product not found. It may have already been deleted.';
        }
        
        showToast('error', 'Delete Failed', errorMessage);
        hideLoading();
    }
}

// Main deleteProduct function - called from the modal
async function deleteProduct(productId) {
    if (!productId && productToDelete) {
        // If called from modal, use stored product
        productId = productToDelete.id;
    }
    
    const product = state.products.find(p => p.id === productId);
    
    if (!product) {
        showToast('error', 'Product Not Found', 'The product you are trying to delete was not found.');
        closeDeleteModal();
        return;
    }
    
    showLoading('Deleting product...');
    
    try {
        // Delete from Firestore
        await db.collection('products').doc(productId).delete();
        
        // Remove from local state
        state.products = state.products.filter(p => p.id !== productId);
        
        // Close modal first
        closeDeleteModal();
        
        // Update UI
        loadProductsForManagement();
        
        // If on POS page, refresh product grid
        if (state.currentPage === 'pos') {
            loadProductsForPOS();
        }
        
        // Show success message
        showToast('success', 'Product Deleted', `${product.name} was deleted successfully.`);
        
        // Update dashboard if open
        if (state.currentPage === 'dashboard') {
            document.getElementById('totalProducts').textContent = state.products.length;
        }
        
        hideLoading();
        
    } catch (error) {
        console.error('Error deleting product:', error);
        
        let errorMessage = 'Failed to delete product. Please try again.';
        if (error.code === 'permission-denied') {
            errorMessage = 'You do not have permission to delete products.';
        } else if (error.code === 'not-found') {
            errorMessage = 'Product not found. It may have already been deleted.';
        }
        
        showToast('error', 'Delete Failed', errorMessage);
        hideLoading();
        
        // Keep modal open on error if user wants to retry
        if (error.code !== 'not-found') {
            document.getElementById('deleteModal').classList.add('active');
        }
    }
}

        // Sales Functions
        async function loadSalesData() {
            showLoading('Loading sales data...');
            
            try {
                const salesSnapshot = await db.collection('sales')
                    .orderBy('timestamp', 'desc')
                    .get();
                
                state.sales = salesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                updateSalesTable();
                hideLoading();
            } catch (error) {
                console.error('Error loading sales data:', error);
                showToast('error', 'Load Failed', 'Failed to load sales data');
                hideLoading();
            }
        }

        function updateSalesTable() {
            const salesTable = document.getElementById('salesTable');
            
            if (state.sales.length === 0) {
                salesTable.innerHTML = '<tr><td colspan="6" class="text-center">No sales records available</td></tr>';
                return;
            }
            
            salesTable.innerHTML = '';
            state.sales.forEach(sale => {
                const date = sale.timestamp ? sale.timestamp.toDate() : new Date();
                const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${sale.transactionId || sale.id.substring(0, 8)}</td>
                    <td>${sale.items ? sale.items.length : 0} items</td>
                    <td>₱${sale.totalCost ? sale.totalCost.toFixed(2) : '0.00'}</td>
                    <td>₱${sale.totalAmount ? sale.totalAmount.toFixed(2) : '0.00'}</td>
                    <td class="${sale.netProfit >= 0 ? 'success' : 'error'}" style="color: ${sale.netProfit >= 0 ? 'var(--success)' : 'var(--error)'}; font-weight: 600;">
                        ₱${sale.netProfit ? sale.netProfit.toFixed(2) : '0.00'}
                    </td>
                `;
                salesTable.appendChild(row);
            });
        }

        async function filterSales() {
            const startDate = document.getElementById('salesStartDate').value;
            const endDate = document.getElementById('salesEndDate').value;
            
            if (!startDate || !endDate) {
                showToast('warning', 'Filter Error', 'Please select both start and end dates');
                return;
            }
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999); // End of the day
            
            showLoading('Filtering sales...');
            
            try {
                const salesSnapshot = await db.collection('sales')
                    .where('timestamp', '>=', start)
                    .where('timestamp', '<=', end)
                    .orderBy('timestamp', 'desc')
                    .get();
                
                const filteredSales = salesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Update table with filtered data
                const salesTable = document.getElementById('salesTable');
                
                if (filteredSales.length === 0) {
                    salesTable.innerHTML = '<tr><td colspan="6" class="text-center">No sales found for the selected date range</td></tr>';
                } else {
                    salesTable.innerHTML = '';
                    filteredSales.forEach(sale => {
                        const date = sale.timestamp ? sale.timestamp.toDate() : new Date();
                        const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${formattedDate}</td>
                            <td>${sale.transactionId || sale.id.substring(0, 8)}</td>
                            <td>${sale.items ? sale.items.length : 0} items</td>
                            <td>₱${sale.totalCost ? sale.totalCost.toFixed(2) : '0.00'}</td>
                            <td>₱${sale.totalAmount ? sale.totalAmount.toFixed(2) : '0.00'}</td>
                            <td class="${sale.netProfit >= 0 ? 'success' : 'error'}" style="color: ${sale.netProfit >= 0 ? 'var(--success)' : 'var(--error)'}; font-weight: 600;">
                                ₱${sale.netProfit ? sale.netProfit.toFixed(2) : '0.00'}
                            </td>
                        `;
                        salesTable.appendChild(row);
                    });
                }
                
                hideLoading();
            } catch (error) {
                console.error('Error filtering sales:', error);
                showToast('error', 'Filter Failed', 'Failed to filter sales data');
                hideLoading();
            }
        }

        function resetSalesFilter() {
            document.getElementById('salesStartDate').value = '';
            document.getElementById('salesEndDate').value = '';
            updateSalesTable();
        }

        // Reports Functions
        function handleReportPeriodChange() {
            const period = document.getElementById('reportPeriod').value;
            
            // Hide all specific input groups
            document.getElementById('specificDateGroup').style.display = 'none';
            document.getElementById('specificWeekGroup').style.display = 'none';
            document.getElementById('specificMonthGroup').style.display = 'none';
            
            // Show the relevant input group
            if (period === 'specificDate') {
                document.getElementById('specificDateGroup').style.display = 'flex';
            } else if (period === 'specificWeek') {
                document.getElementById('specificWeekGroup').style.display = 'flex';
            } else if (period === 'specificMonth') {
                document.getElementById('specificMonthGroup').style.display = 'flex';
            }
        }

        async function generateReportData() {
            const period = document.getElementById('reportPeriod').value;
            let startDate, endDate;
            
            // Calculate date range based on period
            const now = new Date();
            
            switch(period) {
                case 'today':
                    startDate = new Date(now);
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(now);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                    
                case 'specificDate':
                    const specificDate = document.getElementById('specificDate').value;
                    if (!specificDate) {
                        showToast('warning', 'Date Required', 'Please select a specific date');
                        return;
                    }
                    startDate = new Date(specificDate);
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(specificDate);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                    
                case 'thisWeek':
                    // Start of week (Sunday)
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - now.getDay());
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(now);
                    endDate.setDate(now.getDate() + (6 - now.getDay()));
                    endDate.setHours(23, 59, 59, 999);
                    break;
                    
                case 'specificWeek':
                    const specificWeek = document.getElementById('specificWeek').value;
                    if (!specificWeek) {
                        showToast('warning', 'Week Required', 'Please select a specific week');
                        return;
                    }
                    // Parse year and week number
                    const [year, week] = specificWeek.split('-W');
                    startDate = getDateOfISOWeek(parseInt(week), parseInt(year));
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                    
                case 'thisMonth':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                    
                case 'specificMonth':
                    const specificMonth = document.getElementById('specificMonth').value;
                    if (!specificMonth) {
                        showToast('warning', 'Month Required', 'Please select a specific month');
                        return;
                    }
                    const [monthYear, month] = specificMonth.split('-');
                    startDate = new Date(parseInt(monthYear), parseInt(month) - 1, 1);
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(parseInt(monthYear), parseInt(month), 0);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                    
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(now.getFullYear(), 11, 31);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                    
                default:
                    showToast('error', 'Invalid Period', 'Please select a valid report period');
                    return;
            }
            
            showLoading('Generating report...');
            
            try {
                // Get sales for the period
                const salesSnapshot = await db.collection('sales')
                    .where('timestamp', '>=', startDate)
                    .where('timestamp', '<=', endDate)
                    .orderBy('timestamp', 'desc')
                    .get();
                
                const periodSales = salesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Calculate totals
                let totalSales = 0;
                let totalCost = 0;
                let totalProfit = 0;
                let transactionCount = periodSales.length;
                
                periodSales.forEach(sale => {
                    totalSales += sale.totalAmount || 0;
                    totalCost += sale.totalCost || 0;
                    totalProfit += sale.netProfit || 0;
                });
                
                // Update report cards
                document.getElementById('reportSales').textContent = `₱${totalSales.toFixed(2)}`;
                document.getElementById('reportIncome').textContent = `₱${totalSales.toFixed(2)}`;
                document.getElementById('reportPuhunan').textContent = `₱${totalCost.toFixed(2)}`;
                document.getElementById('reportProfit').textContent = `₱${totalProfit.toFixed(2)}`;
                
                // Update report table
                updateReportTable(periodSales, startDate, endDate, period);
                
                hideLoading();
                showToast('success', 'Report Generated', `Report generated for ${period} period`);
            } catch (error) {
                console.error('Error generating report:', error);
                showToast('error', 'Report Failed', 'Failed to generate report data');
                hideLoading();
            }
        }

        function getDateOfISOWeek(week, year) {
            const simple = new Date(year, 0, 1 + (week - 1) * 7);
            const dayOfWeek = simple.getDay();
            const ISOweekStart = simple;
            if (dayOfWeek <= 4) {
                ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
            } else {
                ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
            }
            return ISOweekStart;
        }

        function updateReportTable(sales, startDate, endDate, period) {
            const reportTable = document.getElementById('reportTable');
            
            if (sales.length === 0) {
                reportTable.innerHTML = '<tr><td colspan="6" class="text-center">No sales data for the selected period</td></tr>';
                return;
            }
            
            // Group sales by date for daily breakdown
            const salesByDate = {};
            sales.forEach(sale => {
                const date = sale.timestamp ? sale.timestamp.toDate() : new Date();
                const dateKey = date.toISOString().split('T')[0]; // YYYY-MM-DD
                
                if (!salesByDate[dateKey]) {
                    salesByDate[dateKey] = {
                        date: date,
                        sales: 0,
                        cost: 0,
                        profit: 0,
                        count: 0
                    };
                }
                
                salesByDate[dateKey].sales += sale.totalAmount || 0;
                salesByDate[dateKey].cost += sale.totalCost || 0;
                salesByDate[dateKey].profit += sale.netProfit || 0;
                salesByDate[dateKey].count += 1;
            });
            
            // Convert to array and sort by date
            const salesArray = Object.values(salesByDate).sort((a, b) => b.date - a.date);
            
            reportTable.innerHTML = '';
            salesArray.forEach(day => {
                const dateStr = day.date.toLocaleDateString();
                const profitMargin = day.sales > 0 ? (day.profit / day.sales) * 100 : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${dateStr}</td>
                    <td>${day.count}</td>
                    <td>₱${day.sales.toFixed(2)}</td>
                    <td>₱${day.cost.toFixed(2)}</td>
                    <td class="${day.profit >= 0 ? 'success' : 'error'}" style="color: ${day.profit >= 0 ? 'var(--success)' : 'var(--error)'}; font-weight: 600;">
                        ₱${day.profit.toFixed(2)}
                    </td>
                    <td class="${profitMargin >= 0 ? 'success' : 'error'}" style="color: ${profitMargin >= 0 ? 'var(--success)' : 'var(--error)'}">
                        ${profitMargin.toFixed(1)}%
                    </td>
                `;
                reportTable.appendChild(row);
            });
            
            // Add total row
            const totalSales = sales.reduce((sum, sale) => sum + (sale.totalAmount || 0), 0);
            const totalCost = sales.reduce((sum, sale) => sum + (sale.totalCost || 0), 0);
            const totalProfit = sales.reduce((sum, sale) => sum + (sale.netProfit || 0), 0);
            const totalMargin = totalSales > 0 ? (totalProfit / totalSales) * 100 : 0;
            
            const totalRow = document.createElement('tr');
            totalRow.style.fontWeight = 'bold';
            totalRow.style.backgroundColor = 'var(--background-alt)';
            totalRow.innerHTML = `
                <td>TOTAL</td>
                <td>${sales.length}</td>
                <td>₱${totalSales.toFixed(2)}</td>
                <td>₱${totalCost.toFixed(2)}</td>
                <td class="${totalProfit >= 0 ? 'success' : 'error'}" style="color: ${totalProfit >= 0 ? 'var(--success)' : 'var(--error)'}">
                    ₱${totalProfit.toFixed(2)}
                </td>
                <td class="${totalMargin >= 0 ? 'success' : 'error'}" style="color: ${totalMargin >= 0 ? 'var(--success)' : 'var(--error)'}">
                    ${totalMargin.toFixed(1)}%
                </td>
            `;
            reportTable.appendChild(totalRow);
        }

        function resetReportUI() {
            document.getElementById('reportPeriod').value = 'today';
            document.getElementById('specificDate').value = '';
            document.getElementById('specificWeek').value = '';
            document.getElementById('specificMonth').value = '';
            
            handleReportPeriodChange();
            
            document.getElementById('reportSales').textContent = '₱0.00';
            document.getElementById('reportIncome').textContent = '₱0.00';
            document.getElementById('reportPuhunan').textContent = '₱0.00';
            document.getElementById('reportProfit').textContent = '₱0.00';
            
            document.getElementById('reportTable').innerHTML = '<tr><td colspan="6" class="text-center">Select a report period and click "Generate Report"</td></tr>';
        }

        async function generatePDFReport() {
            const reportSales = document.getElementById('reportSales').textContent;
            const reportIncome = document.getElementById('reportIncome').textContent;
            const reportCost = document.getElementById('reportPuhunan').textContent;
            const reportProfit = document.getElementById('reportProfit').textContent;
            
            // Check if report data is available
            if (reportSales === '₱0.00' && reportProfit === '₱0.00') {
                showToast('warning', 'No Data', 'Please generate a report first before creating a PDF');
                return;
            }
            
            showLoading('Generating PDF report...');
            
            try {
                // Create PDF document
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('portrait', 'mm', 'a4');
                
                // Set document properties
                doc.setProperties({
                    title: 'Ziamyang Income Report',
                    subject: 'Business Income Report',
                    author: 'Ziamyang POS System',
                    keywords: 'income, report, sales, profit',
                    creator: 'Ziamyang POS System'
                });
                
                // Add logo and header
                doc.setFontSize(24);
                doc.setTextColor(255, 100, 0); // Primary color
                doc.setFont('helvetica', 'bold');
                doc.text('Ziamyang', 105, 20, { align: 'center' });
                
                doc.setFontSize(12);
                doc.setTextColor(50, 50, 50); // Text color
                doc.setFont('helvetica', 'normal');
                doc.text('Your Go-To Spicy Fix', 105, 27, { align: 'center' });
                
                // Add report title
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('Income Report', 105, 40, { align: 'center' });
                
                // Add date range
                const period = document.getElementById('reportPeriod').value;
                const periodText = document.getElementById('reportPeriod').options[document.getElementById('reportPeriod').selectedIndex].text;
                const reportDate = new Date().toLocaleDateString();
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(`Report Period: ${periodText}`, 20, 50);
                doc.text(`Generated: ${reportDate}`, 20, 55);
                
                // Add summary section
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('Summary', 20, 65);
                
                // Add summary table
                doc.autoTable({
                    startY: 70,
                    head: [['Metric', 'Amount']],
                    body: [
                        ['Total Sales', reportSales],
                        ['Total Income', reportIncome],
                        ['Total Cost', reportCost],
                        ['Net Profit', reportProfit]
                    ],
                    theme: 'grid',
                    headStyles: { fillColor: [255, 100, 0], textColor: [255, 255, 255] },
                    alternateRowStyles: { fillColor: [245, 245, 245] },
                    margin: { left: 20, right: 20 }
                });
                
                // Add detailed sales table if available
                const table = document.getElementById('reportTable');
                const rows = table.querySelectorAll('tbody tr');
                
                if (rows.length > 0 && !rows[0].querySelector('td').textContent.includes('Select a report')) {
                    let tableData = [];
                    
                    rows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length === 6) {
                            const rowData = [
                                cells[0].textContent,
                                cells[1].textContent,
                                cells[2].textContent,
                                cells[3].textContent,
                                cells[4].textContent,
                                cells[5].textContent
                            ];
                            tableData.push(rowData);
                        }
                    });
                    
                    if (tableData.length > 0) {
                        const finalY = doc.lastAutoTable.finalY || 100;
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Detailed Sales Breakdown', 20, finalY + 15);
                        
                        doc.autoTable({
                            startY: finalY + 20,
                            head: [['Date', 'Transactions', 'Sales', 'Cost', 'Net Profit', 'Margin']],
                            body: tableData,
                            theme: 'grid',
                            headStyles: { fillColor: [50, 50, 50], textColor: [255, 255, 255] },
                            alternateRowStyles: { fillColor: [245, 245, 245] },
                            margin: { left: 20, right: 20 }
                        });
                    }
                }
                
                // Add footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(128, 128, 128);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Page ${i} of ${pageCount}`, 105, 285, { align: 'center' });
                    doc.text('Powered by: Wxyz Development | Steven Macapañas', 105, 290, { align: 'center' });
                }
                
                // Save PDF
                const reportName = `Ziamyang_Income_Report_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(reportName);
                
                hideLoading();
                showToast('success', 'PDF Generated', 'Report downloaded successfully');
            } catch (error) {
                console.error('Error generating PDF:', error);
                hideLoading();
                showToast('error', 'PDF Generation Failed', 'Failed to generate PDF report');
            }
        }

        // Settings Functions
        function switchSettingsTab(tab) {
            // Hide all settings sections
            document.querySelectorAll('.settings-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Remove active class from all nav links
            document.querySelectorAll('.settings-nav a').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected section
            const section = document.getElementById(`${tab}Settings`);
            if (section) {
                section.style.display = 'block';
            }
            
            // Set active nav link
            const navLink = document.querySelector(`.settings-nav a[data-settings="${tab}"]`);
            if (navLink) navLink.classList.add('active');
        }

        function handleAvatarUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Check file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showToast('error', 'File Too Large', 'Please select an image smaller than 2MB');
                return;
            }
            
            // Check file type
            if (!file.type.match('image.*')) {
                showToast('error', 'Invalid File', 'Please select a valid image file');
                return;
            }
            
            showLoading('Uploading image...');
            
            // Convert to Base64
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const base64Image = event.target.result;
                    
                    // Update user avatar in Firestore
                    await db.collection('users').doc(state.currentUser.uid).update({
                        avatar: base64Image
                    });
                    
                    // Update local state
                    state.userData.avatar = base64Image;
                    
                    // Update UI
                    avatarImage.src = base64Image;
                    avatarImage.style.display = 'block';
                    avatarInitials.style.display = 'none';
                    
                    // Update preview
                    const avatarPreviewImage = document.getElementById('avatarPreviewImage');
                    const avatarPreviewText = document.getElementById('avatarPreviewText');
                    avatarPreviewImage.src = base64Image;
                    avatarPreviewImage.style.display = 'block';
                    avatarPreviewText.style.display = 'none';
                    
                    hideLoading();
                    showToast('success', 'Avatar Updated', 'Profile picture updated successfully');
                } catch (error) {
                    console.error('Error updating avatar:', error);
                    hideLoading();
                    showToast('error', 'Upload Failed', 'Failed to update profile picture');
                }
            };
            
            reader.readAsDataURL(file);
        }

        async function updateProfile(e) {
            e.preventDefault();
            showLoading('Updating profile...');
            
            const name = document.getElementById('profileName').value.trim();
            
            if (!name) {
                showToast('error', 'Validation Error', 'Name cannot be empty');
                hideLoading();
                return;
            }
            
            try {
                // Update user data in Firestore
                await db.collection('users').doc(state.currentUser.uid).update({
                    name: name
                });
                
                // Update local state
                state.userData.name = name;
                
                // Update UI
                userName.textContent = name;
                const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                avatarInitials.textContent = initials;
                
                // Update avatar preview text if no image
                if (!state.userData.avatar) {
                    document.getElementById('avatarPreviewText').textContent = initials;
                }
                
                hideLoading();
                showToast('success', 'Profile Updated', 'Profile information updated successfully');
            } catch (error) {
                console.error('Error updating profile:', error);
                hideLoading();
                showToast('error', 'Update Failed', 'Failed to update profile');
            }
        }

        async function changePassword(e) {
            e.preventDefault();
            showLoading('Changing password...');
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            
            if (newPassword !== confirmNewPassword) {
                showToast('error', 'Password Mismatch', 'New passwords do not match');
                hideLoading();
                return;
            }
            
            if (newPassword.length < 6) {
                showToast('error', 'Weak Password', 'Password must be at least 6 characters');
                hideLoading();
                return;
            }
            
            try {
                // Reauthenticate user
                const credential = firebase.auth.EmailAuthProvider.credential(
                    state.currentUser.email,
                    currentPassword
                );
                
                await state.currentUser.reauthenticateWithCredential(credential);
                
                // Update password
                await state.currentUser.updatePassword(newPassword);
                
                // Clear form
                document.getElementById('passwordForm').reset();
                
                hideLoading();
                showToast('success', 'Password Changed', 'Password updated successfully');
            } catch (error) {
                console.error('Error changing password:', error);
                hideLoading();
                
                let errorMessage = 'Failed to change password';
                if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Current password is incorrect';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'New password is too weak';
                }
                
                showToast('error', 'Password Change Failed', errorMessage);
            }
        }

        async function savePreferences() {
            showLoading('Saving preferences...');
            
            // Get theme preference
            const themeMode = document.querySelector('input[name="themeMode"]:checked').value;
            
            // Get notification preferences
            const notifySales = document.getElementById('notifySales').checked;
            const notifyLowStock = document.getElementById('notifyLowStock').checked;
            const notifyReports = document.getElementById('notifyReports').checked;
            
            try {
                // Update preferences in Firestore
                await db.collection('users').doc(state.currentUser.uid).update({
                    'preferences.theme': themeMode,
                    'preferences.notifications': {
                        sales: notifySales,
                        lowStock: notifyLowStock,
                        reports: notifyReports
                    }
                });
                
                // Update local state
                if (!state.userData.preferences) {
                    state.userData.preferences = {};
                }
                state.userData.preferences.theme = themeMode;
                state.userData.preferences.notifications = {
                    sales: notifySales,
                    lowStock: notifyLowStock,
                    reports: notifyReports
                };
                
                // Apply theme if changed
                if (state.theme !== themeMode) {
                    setTheme(themeMode);
                }
                
                hideLoading();
                showToast('success', 'Preferences Saved', 'Your preferences have been saved');
            } catch (error) {
                console.error('Error saving preferences:', error);
                hideLoading();
                showToast('error', 'Save Failed', 'Failed to save preferences');
            }
        }

        // Anti-debugging protection
(function() {
    // Prevent console access
    const consoleMethods = ['log', 'info', 'warn', 'error', 'debug', 'trace'];
    consoleMethods.forEach(method => {
        console[method] = function() {};
    });
    
    // Override alert to prevent debugging
    window.alert = function() {};
    
    // Prevent F12 key
    document.addEventListener('keydown', function(e) {
        // F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+Shift+C, Ctrl+U
        if (e.keyCode === 123 || 
            (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74 || e.keyCode === 67)) ||
            (e.ctrlKey && e.keyCode === 85)) {
            e.preventDefault();
            e.stopPropagation();
            return false;
        }
    });
    
    // Prevent right-click context menu
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        return false;
    });
    
    // Prevent selection
    document.addEventListener('selectstart', function(e) {
        e.preventDefault();
        return false;
    });
    
    // Detect devtools opening
    const devtools = /./;
    devtools.toString = function() {
        // This will fire when devtools is opened
        window.location.reload();
        return '';
    };
    
    setInterval(function() {
        console.log(devtools);
    }, 1000);
})();
    </script>
</body>
</html>
